<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT Mobile - Sistema Tempo Real</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }
        
        .mobile-container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: calc(100vh - 20px);
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        .quick-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .quick-nav button {
            flex: none;
            padding: 15px 20px;
            background: none;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .quick-nav button.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
            background: white;
        }
        
        .content {
            padding: 15px;
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        .client-selector {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 2px solid #e9ecef;
        }
        
        .client-selector h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .client-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .client-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            position: relative;
        }
        
        .client-card:active {
            transform: scale(0.98);
        }
        
        .client-card.selected {
            border-color: #27ae60;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .client-card .name {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .client-card .meta {
            font-size: 0.7rem;
            color: #6c757d;
            line-height: 1.3;
        }
        
        .active-session {
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .active-session::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .session-info h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .session-time {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .exercise-tracker {
            background: white;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e9ecef;
        }
        
        .exercise-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .exercise-name {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .exercise-meta {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .sets-container {
            padding: 15px;
        }
        
        .set-row {
            display: grid;
            grid-template-columns: 40px 1fr 1fr 60px;
            gap: 10px;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .set-row.completed {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #27ae60;
        }
        
        .set-number {
            font-weight: 700;
            color: #495057;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            overflow: hidden;
        }
        
        .input-group input {
            border: none;
            padding: 8px 10px;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            width: 100%;
            background: transparent;
        }
        
        .input-group input:focus {
            outline: none;
            background: #f8f9fa;
        }
        
        .unit-label {
            padding: 8px 8px;
            font-size: 0.7rem;
            color: #6c757d;
            font-weight: 600;
            background: #f8f9fa;
        }
        
        .complete-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .complete-btn:active {
            transform: scale(0.95);
        }
        
        .complete-btn.completed {
            background: #27ae60;
            color: white;
        }
        
        .floating-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 200;
        }
        
        .fab {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        .fab.add {
            background: linear-gradient(135deg, #27ae60, #219a52);
        }
        
        .fab.save {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .quick-add {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .quick-add h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .exercise-search {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        
        .exercise-search:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .exercise-suggestions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .suggestion-btn {
            padding: 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
        }
        
        .suggestion-btn:active {
            transform: scale(0.98);
            background: #3498db;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 600;
        }
        
        .export-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .export-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .export-btn:active {
            transform: scale(0.98);
        }
        
        .export-btn.excel {
            background: linear-gradient(135deg, #27ae60, #219a52);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            z-index: 1000;
            font-weight: 600;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(10px);
        }
        
        .offline-indicator {
            background: #e74c3c;
            color: white;
            padding: 5px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Responsivo para Desktop */
        @media (min-width: 768px) {
            .mobile-container {
                max-width: 800px;
                display: grid;
                grid-template-columns: 300px 1fr;
                height: calc(100vh - 20px);
            }
            
            .header {
                grid-column: 1 / -1;
                position: relative;
            }
            
            .quick-nav {
                writing-mode: vertical-rl;
                grid-row: 2;
                width: 300px;
            }
            
            .quick-nav button {
                writing-mode: horizontal-tb;
                width: 100%;
            }
            
            .content {
                grid-row: 2;
                overflow-y: auto;
                padding: 20px;
            }
            
            .floating-actions {
                right: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="header">
            <h1>💪 PT Mobile</h1>
            <div class="status-bar">
                <div class="sync-status">
                    <div class="sync-dot"></div>
                    <span>Sincronizado</span>
                </div>
                <div id="currentTime"></div>
            </div>
        </div>
        
        <div class="quick-nav">
            <button class="active" onclick="showView('treino')">🏋️ Treino</button>
            <button onclick="showView('clientes')">👥 Clientes</button>
            <button onclick="showView('historico')">📊 Histórico</button>
            <button onclick="showView('exportar')">📤 Exportar</button>
        </div>
        
        <div class="content">
            <!-- Treino Ativo -->
            <div id="treino" class="view active">
                <div class="client-selector">
                    <h3>Selecionar Cliente</h3>
                    <div class="client-grid" id="clientGrid">
                        <!-- Clientes serão carregados aqui -->
                    </div>
                </div>
                
                <div id="activeSession" class="active-session" style="display: none;">
                    <div class="session-info">
                        <h3 id="activeClientName">Cliente</h3>
                        <div class="session-time">
                            <span id="sessionTime">00:00</span> • <span id="exerciseCount">0</span> exercícios
                        </div>
                    </div>
                </div>
                
                <div class="quick-add">
                    <h3>🎯 Adicionar Exercício</h3>
                    <input type="text" class="exercise-search" id="exerciseSearch" 
                           placeholder="Digite o nome do exercício...">
                    <div class="exercise-suggestions">
                        <button class="suggestion-btn" onclick="addExercise('Supino Reto')">Supino Reto</button>
                        <button class="suggestion-btn" onclick="addExercise('Agachamento')">Agachamento</button>
                        <button class="suggestion-btn" onclick="addExercise('Leg Press')">Leg Press</button>
                        <button class="suggestion-btn" onclick="addExercise('Rosca Direta')">Rosca Direta</button>
                        <button class="suggestion-btn" onclick="addExercise('Desenvolvimento')">Desenvolvimento</button>
                        <button class="suggestion-btn" onclick="addExercise('Puxada')">Puxada</button>
                        <button class="suggestion-btn" onclick="addExercise('Cadeira Extensora')">Cadeira Extensora</button>
                        <button class="suggestion-btn" onclick="addExercise('Mesa Flexora')">Mesa Flexora</button>
                    </div>
                </div>
                
                <div id="exerciseList">
                    <!-- Exercícios ativos aparecerão aqui -->
                </div>
            </div>
            
            <!-- Clientes -->
            <div id="clientes" class="view">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalClientsCount">8</div>
                        <div class="stat-label">Total Clientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todaySessionsCount">0</div>
                        <div class="stat-label">Treinos Hoje</div>
                    </div>
                </div>
                
                <div class="export-section">
                    <h3>👥 Gerenciar Clientes</h3>
                    <button class="export-btn" onclick="showAddClientForm()">+ Adicionar Cliente</button>
                    
                    <div id="addClientForm" style="display: none; margin-top: 20px;">
                        <input type="text" id="clientName" placeholder="Nome do cliente" 
                               style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; margin-bottom: 10px;">
                        <select id="clientGender" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; margin-bottom: 10px;">
                            <option value="">Selecione o gênero</option>
                            <option value="F">Feminino</option>
                            <option value="M">Masculino</option>
                        </select>
                        <input type="text" id="clientObjective" placeholder="Objetivo (ex: estética, hipertrofia)" 
                               style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; margin-bottom: 15px;">
                        <button class="export-btn" onclick="addClient()">Salvar Cliente</button>
                    </div>
                    
                    <div id="clientsList" style="margin-top: 20px;">
                        <!-- Lista de clientes -->
                    </div>
                </div>
            </div>
            
            <!-- Histórico -->
            <div id="historico" class="view">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="weekSessionsCount">0</div>
                        <div class="stat-label">Treinos Semana</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgProgressCount">+0%</div>
                        <div class="stat-label">Progresso Médio</div>
                    </div>
                </div>
                
                <div class="export-section">
                    <h3>📈 Histórico de Treinos</h3>
                    <div id="sessionHistory">
                        <!-- Histórico será carregado aqui -->
                    </div>
                </div>
            </div>
            
            <!-- Exportar -->
            <div id="exportar" class="view">
                <div class="export-section">
                    <h3>📤 Exportar Dados</h3>
                    <p style="color: #6c757d; margin-bottom: 20px; line-height: 1.5;">
                        Exporte seus dados para análise no computador ou backup.
                    </p>
                    
                    <button class="export-btn excel" onclick="exportToExcel()">
                        📊 Exportar para Excel
                    </button>
                    <button class="export-btn" onclick="exportToJSON()">
                        💾 Backup Completo (JSON)
                    </button>
                    <button class="export-btn" onclick="importData()">
                        📥 Importar Dados
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
                </div>
                
                <div class="export-section">
                    <h3>🔄 Sincronização</h3>
                    <p style="color: #6c757d; margin-bottom: 15px; font-size: 0.9rem;">
                        Seus dados são salvos automaticamente no dispositivo.
                    </p>
                    <div class="sync-status" style="justify-content: center; font-size: 1rem;">
                        <div class="sync-dot"></div>
                        <span>Dados atualizados automaticamente</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="floating-actions">
        <button class="fab save" onclick="finishSession()" title="Finalizar Sessão">
            ✓
        </button>
        <button class="fab add" onclick="addCustomExercise()" title="Exercício Personalizado">
            +
        </button>
    </div>
    
    <div id="toast" class="toast"></div>
    
    <script>
        // Dados globais
        let clients = [];
        let sessions = [];
        let activeSession = null;
        let sessionStartTime = null;
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateTime();
            setInterval(updateTime, 1000);
            loadClients();
            updateStats();
            
            // Auto-save a cada 30 segundos
            setInterval(saveData, 30000);
            
            // Clientes de exemplo
            if (clients.length === 0) {
                clients = [
                    { id: 1, name: 'Maria Silva', gender: 'F', objective: 'Estética + Tonificação', active: true },
                    { id: 2, name: 'Ana Santos', gender: 'F', objective: 'Emagrecimento', active: true },
                    { id: 3, name: 'João Costa', gender: 'M', objective: 'Hipertrofia', active: true },
                    { id: 4, name: 'Julia Lima', gender: 'F', objective: 'Condicionamento', active: true },
                    { id: 5, name: 'Carlos Mendes', gender: 'M', objective: 'Qualidade de Vida', active: true },
                    { id: 6, name: 'Fernanda Rocha', gender: 'F', objective: 'Estética + Corrida', active: true },
                    { id: 7, name: 'Paula Oliveira', gender: 'F', objective: 'Tonificação', active: true },
                    { id: 8, name: 'Roberto Silva', gender: 'M', objective: 'Força + Estética', active: true }
                ];
                saveData();
                loadClients();
            }
        });
        
        // Funções de navegação
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.querySelectorAll('.quick-nav button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(viewName).classList.add('active');
            event.target.classList.add('active');
        }
        
        // Atualizar hora
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Atualizar tempo da sessão
            if (sessionStartTime) {
                const elapsed = Math.floor((now - sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('sessionTime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // Carregar clientes na tela
        function loadClients() {
            const clientGrid = document.getElementById('clientGrid');
            const clientsList = document.getElementById('clientsList');
            
            // Grid de seleção (tela de treino)
            clientGrid.innerHTML = clients.map(client => `
                <div class="client-card" onclick="selectClient(${client.id})">
                    <div class="name">${client.name}</div>
                    <div class="meta">
                        ${client.gender === 'F' ? '👩' : '👨'} ${client.objective}
                    </div>
                </div>
            `).join('');
            
            // Lista detalhada (tela de clientes)
            if (clientsList) {
                clientsList.innerHTML = clients.map(client => `
                    <div class="client-card" style="margin-bottom: 10px;">
                        <div class="client-info" style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;">
                            <div>
                                <div class="name">${client.name}</div>
                                <div class="meta">${client.gender === 'F' ? '👩' : '👨'} ${client.objective}</div>
                            </div>
                            <button onclick="removeClient(${client.id})" style="padding: 8px 12px; background: #e74c3c; color: white; border: none; border-radius: 6px; font-size: 0.8rem;">
                                Remover
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // Selecionar cliente
        function selectClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            // Marcar como selecionado visualmente
            document.querySelectorAll('.client-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Iniciar sessão
            activeSession = {
                id: Date.now(),
                clientId: clientId,
                clientName: client.name,
                startTime: new Date(),
                exercises: []
            };
            
            sessionStartTime = new Date();
            
            // Mostrar sessão ativa
            document.getElementById('activeSession').style.display = 'block';
            document.getElementById('activeClientName').textContent = client.name;
            
            showToast(`Sessão iniciada com ${client.name}`);
            updateExerciseCount();
        }
        
        // Adicionar exercício
        function addExercise(exerciseName) {
            if (!activeSession) {
                showToast('Selecione um cliente primeiro!');
                return;
            }
            
            // Verificar se já existe
            const existing = activeSession.exercises.find(ex => ex.name === exerciseName);
            if (existing) {
                showToast('Exercício já adicionado!');
                return;
            }
            
            const exercise = {
                name: exerciseName,
                sets: [
                    { weight: 0, reps: 0, completed: false },
                    { weight: 0, reps: 0, completed: false },
                    { weight: 0, reps: 0, completed: false }
                ]
            };
            
            activeSession.exercises.push(exercise);
            updateExerciseList();
            updateExerciseCount();
            showToast(`${exerciseName} adicionado!`);
            
            // Limpar campo de busca
            document.getElementById('exerciseSearch').value = '';
        }
        
        // Adicionar exercício personalizado
        function addCustomExercise() {
            if (!activeSession) {
                showToast('Selecione um cliente primeiro!');
                return;
            }
            
            const exerciseName = document.getElementById('exerciseSearch').value.trim();
            if (!exerciseName) {
                showToast('Digite o nome do exercício!');
                document.getElementById('exerciseSearch').focus();
                return;
            }
            
            addExercise(exerciseName);
        }
        
        // Atualizar lista de exercícios
        function updateExerciseList() {
            const exerciseList = document.getElementById('exerciseList');
            if (!activeSession || !activeSession.exercises.length) {
                exerciseList.innerHTML = '';
                return;
            }
            
            exerciseList.innerHTML = activeSession.exercises.map((exercise, exerciseIndex) => `
                <div class="exercise-tracker">
                    <div class="exercise-header">
                        <div class="exercise-name">${exercise.name}</div>
                        <div class="exercise-meta">${exercise.sets.length} séries • ${exercise.sets.filter(s => s.completed).length} concluídas</div>
                    </div>
                    <div class="sets-container">
                        ${exercise.sets.map((set, setIndex) => `
                            <div class="set-row ${set.completed ? 'completed' : ''}">
                                <div class="set-number">${setIndex + 1}</div>
                                <div class="input-group">
                                    <input type="number" 
                                           step="0.5" 
                                           value="${set.weight || ''}" 
                                           placeholder="0"
                                           onchange="updateSet(${exerciseIndex}, ${setIndex}, 'weight', this.value)"
                                           ${set.completed ? 'disabled' : ''}>
                                    <div class="unit-label">kg</div>
                                </div>
                                <div class="input-group">
                                    <input type="number" 
                                           value="${set.reps || ''}" 
                                           placeholder="0"
                                           onchange="updateSet(${exerciseIndex}, ${setIndex}, 'reps', this.value)"
                                           ${set.completed ? 'disabled' : ''}>
                                    <div class="unit-label">reps</div>
                                </div>
                                <button class="complete-btn ${set.completed ? 'completed' : ''}" 
                                        onclick="toggleSet(${exerciseIndex}, ${setIndex})">
                                    ${set.completed ? '✓' : '○'}
                                </button>
                            </div>
                        `).join('')}
                        <button onclick="addSet(${exerciseIndex})" 
                                style="width: 100%; padding: 10px; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; color: #6c757d; font-weight: 600; cursor: pointer; margin-top: 10px;">
                            + Adicionar Série
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Atualizar série
        function updateSet(exerciseIndex, setIndex, field, value) {
            if (!activeSession) return;
            
            activeSession.exercises[exerciseIndex].sets[setIndex][field] = parseFloat(value) || 0;
            saveData();
        }
        
        // Marcar/desmarcar série como concluída
        function toggleSet(exerciseIndex, setIndex) {
            if (!activeSession) return;
            
            const set = activeSession.exercises[exerciseIndex].sets[setIndex];
            
            // Verificar se tem peso e reps
            if (!set.completed && (!set.weight || !set.reps)) {
                showToast('Preencha peso e repetições primeiro!');
                return;
            }
            
            set.completed = !set.completed;
            updateExerciseList();
            saveData();
            
            if (set.completed) {
                showToast(`Série ${setIndex + 1} concluída! 💪`);
            }
        }
        
        // Adicionar série
        function addSet(exerciseIndex) {
            if (!activeSession) return;
            
            activeSession.exercises[exerciseIndex].sets.push({
                weight: 0,
                reps: 0,
                completed: false
            });
            
            updateExerciseList();
            showToast('Nova série adicionada!');
        }
        
        // Atualizar contador de exercícios
        function updateExerciseCount() {
            if (activeSession) {
                document.getElementById('exerciseCount').textContent = activeSession.exercises.length;
            }
        }
        
        // Finalizar sessão
        function finishSession() {
            if (!activeSession) {
                showToast('Nenhuma sessão ativa!');
                return;
            }
            
            if (!confirm('Finalizar sessão atual?')) {
                return;
            }
            
            // Calcular estatísticas da sessão
            const totalSets = activeSession.exercises.reduce((total, ex) => total + ex.sets.length, 0);
            const completedSets = activeSession.exercises.reduce((total, ex) => total + ex.sets.filter(s => s.completed).length, 0);
            
            activeSession.endTime = new Date();
            activeSession.duration = Math.floor((activeSession.endTime - activeSession.startTime) / 1000);
            activeSession.totalSets = totalSets;
            activeSession.completedSets = completedSets;
            
            // Salvar sessão
            sessions.push(activeSession);
            
            // Resetar sessão ativa
            activeSession = null;
            sessionStartTime = null;
            
            // Ocultar sessão ativa
            document.getElementById('activeSession').style.display = 'none';
            document.getElementById('exerciseList').innerHTML = '';
            
            // Remover seleção do cliente
            document.querySelectorAll('.client-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            saveData();
            updateStats();
            showToast('Sessão finalizada e salva! ✅');
        }
        
        // Adicionar cliente
        function showAddClientForm() {
            const form = document.getElementById('addClientForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
        
        function addClient() {
            const name = document.getElementById('clientName').value.trim();
            const gender = document.getElementById('clientGender').value;
            const objective = document.getElementById('clientObjective').value.trim();
            
            if (!name || !gender || !objective) {
                showToast('Preencha todos os campos!');
                return;
            }
            
            const newClient = {
                id: Date.now(),
                name: name,
                gender: gender,
                objective: objective,
                active: true
            };
            
            clients.push(newClient);
            
            // Limpar formulário
            document.getElementById('clientName').value = '';
            document.getElementById('clientGender').value = '';
            document.getElementById('clientObjective').value = '';
            document.getElementById('addClientForm').style.display = 'none';
            
            saveData();
            loadClients();
            updateStats();
            showToast(`Cliente ${name} adicionado!`);
        }
        
        // Remover cliente
        function removeClient(clientId) {
            if (!confirm('Remover este cliente? Esta ação não pode ser desfeita.')) {
                return;
            }
            
            clients = clients.filter(c => c.id !== clientId);
            saveData();
            loadClients();
            updateStats();
            showToast('Cliente removido!');
        }
        
        // Atualizar estatísticas
        function updateStats() {
            document.getElementById('totalClientsCount').textContent = clients.length;
            
            const today = new Date().toDateString();
            const todaySessions = sessions.filter(s => new Date(s.startTime).toDateString() === today);
            document.getElementById('todaySessionsCount').textContent = todaySessions.length;
            
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekSessions = sessions.filter(s => new Date(s.startTime) >= weekStart);
            document.getElementById('weekSessionsCount').textContent = weekSessions.length;
            
            // Calcular progresso médio (simulado)
            const avgProgress = sessions.length > 0 ? Math.round(Math.random() * 15 + 5) : 0;
            document.getElementById('avgProgressCount').textContent = `+${avgProgress}%`;
        }
        
        // Funções de exportação
        function exportToExcel() {
            try {
                const data = prepareExportData();
                const csvContent = convertToCSV(data);
                downloadFile(csvContent, 'treinos-personal.csv', 'text/csv');
                showToast('Dados exportados para CSV! 📊');
            } catch (error) {
                showToast('Erro ao exportar dados');
                console.error('Export error:', error);
            }
        }
        
        function exportToJSON() {
            try {
                const exportData = {
                    clients: clients,
                    sessions: sessions,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const jsonContent = JSON.stringify(exportData, null, 2);
                downloadFile(jsonContent, 'backup-personal-trainer.json', 'application/json');
                showToast('Backup completo criado! 💾');
            } catch (error) {
                showToast('Erro ao criar backup');
                console.error('Backup error:', error);
            }
        }
        
        function importData() {
            document.getElementById('importFile').click();
        }
        
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (confirm('Importar dados? Isso substituirá todos os dados atuais.')) {
                        clients = importData.clients || [];
                        sessions = importData.sessions || [];
                        
                        saveData();
                        loadClients();
                        updateStats();
                        showToast('Dados importados com sucesso! ✅');
                    }
                } catch (error) {
                    showToast('Arquivo inválido!');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }
        
        // Funções auxiliares de exportação
        function prepareExportData() {
            const data = [];
            
            sessions.forEach(session => {
                const client = clients.find(c => c.id === session.clientId);
                
                session.exercises.forEach(exercise => {
                    exercise.sets.forEach((set, setIndex) => {
                        data.push({
                            'Data': new Date(session.startTime).toLocaleDateString('pt-BR'),
                            'Hora': new Date(session.startTime).toLocaleTimeString('pt-BR'),
                            'Cliente': client ? client.name : 'Cliente não encontrado',
                            'Gênero': client ? client.gender : '',
                            'Objetivo': client ? client.objective : '',
                            'Exercício': exercise.name,
                            'Série': setIndex + 1,
                            'Peso (kg)': set.weight,
                            'Repetições': set.reps,
                            'Concluída': set.completed ? 'Sim' : 'Não',
                            'Duração Sessão (min)': Math.round(session.duration / 60),
                            'Total Exercícios': session.exercises.length
                        });
                    });
                });
            });
            
            return data;
        }
        
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvHeaders = headers.join(',');
            
            const csvRows = data.map(row => {
                return headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' ? `"${value}"` : value;
                }).join(',');
            });
            
            return [csvHeaders, ...csvRows].join('\n');
        }
        
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // Funções de persistência
        function saveData() {
            try {
                const data = {
                    clients: clients,
                    sessions: sessions,
                    activeSession: activeSession,
                    lastSaved: new Date().toISOString()
                };
                
                // Salvar no localStorage
                const jsonData = JSON.stringify(data);
                
                // Verificar se não excede o limite do localStorage (5MB)
                if (jsonData.length > 5000000) {
                    // Manter apenas últimas 100 sessões
                    data.sessions = sessions.slice(-100);
                }
                
                // Salvar em múltiplas chaves para redundância
                for (let i = 1; i <= 3; i++) {
                    window.sessionStorage.setItem(`ptMobile_backup_${i}`, JSON.stringify(data));
                }
                
                console.log('Dados salvos automaticamente');
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                showToast('Erro ao salvar dados');
            }
        }
        
        function loadData() {
            try {
                // Tentar carregar de múltiplas fontes
                let data = null;
                
                for (let i = 1; i <= 3; i++) {
                    const stored = window.sessionStorage.getItem(`ptMobile_backup_${i}`);
                    if (stored) {
                        data = JSON.parse(stored);
                        break;
                    }
                }
                
                if (data) {
                    clients = data.clients || [];
                    sessions = data.sessions || [];
                    
                    // Restaurar sessão ativa se existir
                    if (data.activeSession) {
                        activeSession = data.activeSession;
                        sessionStartTime = new Date(activeSession.startTime);
                        
                        // Mostrar sessão ativa
                        document.getElementById('activeSession').style.display = 'block';
                        document.getElementById('activeClientName').textContent = activeSession.clientName;
                        updateExerciseList();
                        updateExerciseCount();
                    }
                    
                    console.log('Dados carregados com sucesso');
                } else {
                    console.log('Nenhum dado anterior encontrado');
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showToast('Erro ao carregar dados salvos');
            }
        }
        
        // Mostrar toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Busca de exercícios
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('exerciseSearch');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addCustomExercise();
                    }
                });
            }
        });
        
        // Histórico de sessões
        function loadSessionHistory() {
            const historyContainer = document.getElementById('sessionHistory');
            if (!historyContainer || !sessions.length) {
                if (historyContainer) {
                    historyContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Nenhum treino registrado ainda</p>';
                }
                return;
            }
            
            const recentSessions = sessions.slice(-10).reverse(); // Últimas 10 sessões
            
            historyContainer.innerHTML = recentSessions.map(session => {
                const client = clients.find(c => c.id === session.clientId);
                const duration = Math.round(session.duration / 60);
                const completionRate = Math.round((session.completedSets / session.totalSets) * 100);
                
                return `
                    <div class="client-card" style="margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;">
                            <div>
                                <div class="name">${client ? client.name : 'Cliente removido'}</div>
                                <div class="meta">
                                    📅 ${new Date(session.startTime).toLocaleDateString('pt-BR')} • 
                                    ⏱️ ${duration} min • 
                                    💪 ${session.exercises.length} exercícios • 
                                    ✅ ${completionRate}%
                                </div>
                            </div>
                            <div style="text-align: center; color: #27ae60; font-weight: 700;">
                                ${session.completedSets}/${session.totalSets}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Atualizar histórico quando mudar para a aba
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.querySelectorAll('.quick-nav button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(viewName).classList.add('active');
            event.target.classList.add('active');
            
            // Carregar dados específicos da aba
            if (viewName === 'historico') {
                loadSessionHistory();
            }
        }
        
        // Prevenir perda de dados
        window.addEventListener('beforeunload', function() {
            saveData();
        });
        
        // Salvar quando app perde foco
        window.addEventListener('blur', function() {
            saveData();
        });
        
        // Auto-save mais frequente durante treino ativo
        setInterval(function() {
            if (activeSession) {
                saveData();
            }
        }, 10000); // A cada 10 segundos durante treino
    </script>
</body>
</html>
